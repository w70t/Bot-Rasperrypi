{% extends "admin/base.html" %}

{% block title %}User Management{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token }}">
{% endblock %}

{% block content %}
<div class="fade-in">

    <!-- Page Header -->
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-2">User Management</h2>
        <p class="text-gray-600">Manage and monitor all registered users</p>
    </div>

    <!-- Filters & Search -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <form method="GET" action="/admin/users" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">

                <!-- Search -->
                <div class="lg:col-span-2">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-search mr-1"></i> Search by Email
                    </label>
                    <input
                        type="text"
                        id="search"
                        name="search"
                        value="{{ search }}"
                        placeholder="Enter email address..."
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>

                <!-- Plan Filter -->
                <div>
                    <label for="plan" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group mr-1"></i> Plan
                    </label>
                    <select
                        id="plan"
                        name="plan"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">All Plans</option>
                        {% for plan_option in plans %}
                        <option value="{{ plan_option }}" {% if plan_filter == plan_option %}selected{% endif %}>
                            {{ plan_option|capitalize }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-toggle-on mr-1"></i> Status
                    </label>
                    <select
                        id="status"
                        name="status"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="">All Statuses</option>
                        {% for status_option in statuses %}
                        <option value="{{ status_option }}" {% if status_filter == status_option %}selected{% endif %}>
                            {{ status_option|capitalize }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Sort By -->
                <div>
                    <label for="sort_by" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sort mr-1"></i> Sort By
                    </label>
                    <select
                        id="sort_by"
                        name="sort_by"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Created Date</option>
                        <option value="email" {% if sort_by == 'email' %}selected{% endif %}>Email</option>
                        <option value="plan" {% if sort_by == 'plan' %}selected{% endif %}>Plan</option>
                        <option value="requests_used" {% if sort_by == 'requests_used' %}selected{% endif %}>Usage</option>
                    </select>
                </div>

            </div>

            <!-- Action Buttons -->
            <div class="flex items-center justify-between pt-2">
                <div class="flex items-center space-x-2">
                    <button
                        type="submit"
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium"
                    >
                        <i class="fas fa-filter mr-2"></i> Apply Filters
                    </button>
                    <a
                        href="/admin/users"
                        class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 focus:outline-none font-medium"
                    >
                        <i class="fas fa-redo mr-2"></i> Reset
                    </a>
                </div>

                <!-- Sort Order Toggle -->
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-600">Order:</span>
                    <button
                        type="button"
                        onclick="toggleSortOrder()"
                        class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 focus:outline-none"
                    >
                        <i class="fas fa-sort-{{ sort_order == 'desc' ? 'down' : 'up' }} mr-1"></i>
                        {{ sort_order == 'desc' ? 'Newest First' : 'Oldest First' }}
                    </button>
                    <input type="hidden" name="sort_order" id="sort_order" value="{{ sort_order }}">
                </div>
            </div>
        </form>
    </div>

    <!-- Results Summary -->
    <div class="flex items-center justify-between mb-6">
        <div class="text-sm text-gray-600">
            Showing <span class="font-semibold text-gray-800">{{ users|length }}</span> of
            <span class="font-semibold text-gray-800">{{ total_users }}</span> users
        </div>
        <div class="text-sm text-gray-600">
            Page <span class="font-semibold text-gray-800">{{ page }}</span> of
            <span class="font-semibold text-gray-800">{{ total_pages }}</span>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">User</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Plan</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Status</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Usage</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Last Active</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Created</th>
                        <th class="text-left py-4 px-6 text-xs font-semibold text-gray-600 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for user in users %}
                    <tr class="hover:bg-gray-50 transition-colors" id="user-row-{{ loop.index }}">
                        <!-- User Info -->
                        <td class="py-4 px-6">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold mr-3">
                                    {{ user.email[0]|upper }}
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-800">{{ user.email }}</p>
                                    <p class="text-xs text-gray-500">{{ user.api_key_masked }}</p>
                                </div>
                            </div>
                        </td>

                        <!-- Plan -->
                        <td class="py-4 px-6">
                            <span class="badge
                                {% if user.plan == 'free' %}badge-info
                                {% elif user.plan == 'basic' %}badge-success
                                {% elif user.plan == 'pro' %}badge-warning
                                {% else %}bg-purple-100 text-purple-700
                                {% endif %}">
                                <i class="fas fa-layer-group mr-1"></i>
                                {{ user.plan|capitalize }}
                            </span>
                        </td>

                        <!-- Status -->
                        <td class="py-4 px-6">
                            {% if user.is_blocked %}
                            <span class="badge badge-danger" title="{{ user.block_reason }}">
                                <i class="fas fa-ban mr-1"></i> Blocked
                            </span>
                            {% else %}
                            <span class="badge badge-success">
                                <i class="fas fa-check-circle mr-1"></i> {{ user.status|capitalize }}
                            </span>
                            {% endif %}
                        </td>

                        <!-- Usage -->
                        <td class="py-4 px-6">
                            <div class="w-32">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>{{ user.requests_used }}</span>
                                    <span>{{ user.requests_limit }}</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="
                                        {% if user.usage_percentage < 50 %}bg-green-500
                                        {% elif user.usage_percentage < 80 %}bg-yellow-500
                                        {% else %}bg-red-500
                                        {% endif %}
                                        h-2 rounded-full transition-all"
                                        style="width: {{ user.usage_percentage }}%"
                                    ></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">{{ user.usage_percentage }}% used</p>
                            </div>
                        </td>

                        <!-- Last Active -->
                        <td class="py-4 px-6 text-sm text-gray-600">
                            {{ user.last_request_at }}
                        </td>

                        <!-- Created -->
                        <td class="py-4 px-6 text-sm text-gray-600">
                            {{ user.created_at }}
                        </td>

                        <!-- Actions -->
                        <td class="py-4 px-6">
                            <div class="flex items-center space-x-2">
                                {% if user.is_blocked %}
                                <button
                                    onclick="unblockUser('{{ user.email }}')"
                                    class="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 text-xs font-medium"
                                    title="Unblock User"
                                >
                                    <i class="fas fa-unlock"></i>
                                </button>
                                {% else %}
                                <button
                                    onclick="blockUser('{{ user.email }}')"
                                    class="px-3 py-1.5 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 text-xs font-medium"
                                    title="Block User"
                                >
                                    <i class="fas fa-ban"></i>
                                </button>
                                {% endif %}

                                <button
                                    onclick="deleteUser('{{ user.email }}')"
                                    class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 text-xs font-medium"
                                    title="Delete User"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="py-12 text-center">
                            <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">No users found</p>
                            <p class="text-gray-400 text-sm mt-2">Try adjusting your filters</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <!-- Previous Button -->
                <a
                    href="?page={{ page - 1 }}&limit={{ limit }}&search={{ search }}&plan={{ plan_filter }}&status={{ status_filter }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 {% if page <= 1 %}opacity-50 pointer-events-none{% endif %}"
                >
                    <i class="fas fa-chevron-left mr-2"></i> Previous
                </a>

                <!-- Page Numbers -->
                <div class="flex items-center space-x-2">
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                        <a
                            href="?page={{ p }}&limit={{ limit }}&search={{ search }}&plan={{ plan_filter }}&status={{ status_filter }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                            class="px-4 py-2 rounded-lg text-sm font-medium {% if p == page %}bg-blue-600 text-white{% else %}bg-white border border-gray-300 text-gray-700 hover:bg-gray-50{% endif %}"
                        >
                            {{ p }}
                        </a>
                        {% elif p == page - 3 or p == page + 3 %}
                        <span class="px-2 text-gray-500">...</span>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Next Button -->
                <a
                    href="?page={{ page + 1 }}&limit={{ limit }}&search={{ search }}&plan={{ plan_filter }}&status={{ status_filter }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 {% if page >= total_pages %}opacity-50 pointer-events-none{% endif %}"
                >
                    Next <i class="fas fa-chevron-right ml-2"></i>
                </a>
            </div>
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const csrfToken = '{{ csrf_token }}';

    // Toggle sort order
    function toggleSortOrder() {
        const sortOrderInput = document.getElementById('sort_order');
        sortOrderInput.value = sortOrderInput.value === 'desc' ? 'asc' : 'desc';
        document.querySelector('form').submit();
    }

    // Block user
    async function blockUser(email) {
        const reason = prompt('Enter reason for blocking (optional):');
        if (reason === null) return; // User cancelled

        showLoading();

        try {
            const response = await fetchAPI(`/admin/api/users/${encodeURIComponent(email)}/block`, {
                method: 'POST',
                body: JSON.stringify({
                    reason: reason || 'Blocked by admin',
                    csrf_token: csrfToken
                })
            });

            hideLoading();

            if (response.success) {
                showToast(`User ${email} has been blocked`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(response.error || 'Failed to block user', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast(error.message || 'Failed to block user', 'error');
        }
    }

    // Unblock user
    async function unblockUser(email) {
        if (!confirm(`Are you sure you want to unblock ${email}?`)) {
            return;
        }

        showLoading();

        try {
            const response = await fetchAPI(`/admin/api/users/${encodeURIComponent(email)}/unblock`, {
                method: 'POST',
                body: JSON.stringify({
                    csrf_token: csrfToken
                })
            });

            hideLoading();

            if (response.success) {
                showToast(`User ${email} has been unblocked`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(response.error || 'Failed to unblock user', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast(error.message || 'Failed to unblock user', 'error');
        }
    }

    // Delete user
    async function deleteUser(email) {
        if (!confirm(`⚠️ WARNING: Are you sure you want to permanently delete ${email}?\n\nThis action CANNOT be undone and will:\n- Delete all user data\n- Delete all usage logs\n- Revoke API access\n\nType the email to confirm:`)) {
            return;
        }

        const confirmEmail = prompt(`Type "${email}" to confirm deletion:`);
        if (confirmEmail !== email) {
            showToast('Email does not match. Deletion cancelled.', 'warning');
            return;
        }

        showLoading();

        try {
            const response = await fetchAPI(`/admin/api/users/${encodeURIComponent(email)}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-Token': csrfToken
                }
            });

            hideLoading();

            if (response.success) {
                showToast(`User ${email} has been permanently deleted`, 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast(response.error || 'Failed to delete user', 'error');
            }
        } catch (error) {
            hideLoading();
            showToast(error.message || 'Failed to delete user', 'error');
        }
    }

    // Auto-submit form on select change
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', function() {
            if (this.id !== 'sort_order') {
                document.querySelector('form').submit();
            }
        });
    });

    // Search on Enter key
    document.getElementById('search').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            document.querySelector('form').submit();
        }
    });
</script>
{% endblock %}
